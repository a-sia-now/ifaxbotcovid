# ifaxBotCovid - парсер релизов оперштаба

Написан для журналистов Интерфакса, пишущих о коронавирусе.
Сейчас запущен здесь: https://t.me/ifaxcovidbot

### Содержание
1. [Введение](#введение)
2. [Технологии и библиотеки](#технологии-и-библиотеки)
3. [Описание функционала](#описание-функционала):
* [Парсер](#парсер)
* [Промежуточная логика (CovidChef)](#промежуточная-логика-covidchef)
4. [Примеры использования](#примеры-использования)
5. [Структура проекта](#структура-проекта)
6. [Источники](#источники)
7. [Дальнейшая разработка](#дальнейшая-разработка)

### Введение

Бот парсит ежедневные пресс-релизы оперативного штаба по предупреждению распространения коронавируса в России, находит в них цифры и вставляет в шаблоны готовых текстов новостей. Работает с тем, что ему прислали - никаких данных в Сети не ищет и не запрашивает, сам данные на постоянной основе не хранит.

> пользователь отправляет боту текст
> бот находит в тексте нужные цифры и переменные
> заполняет заранее заданные шаблоны
> отправляет их пользователю назад

Примеры пресс-релизов можно найти в папке texts/test_data. Файлы с *corrupted* в названии должны выдать ошибку.

* Бот ищет в общей сложности *11 переменных* в пресс-релизе: число новых случаев коронавируса в России и в Москве за сутки, общее число случаев за все время, число смертей за сутки и за все время, число выздоровевших за сутки и за все время и др. Список всех переменных и их описание есть в readme, который лежит в папке /ifaxbotcovid/config/templates.
* Также бот переписывает "таблицы" - длинные списки новых случаев и смертей в регионах РФ, которые представлены в каждом пресс-релизе. Алгоритм автоматически находит эти таблицы, определяет тип таблицы и тип региона, сортирует список, меняет длинные официальные названия регионов на короткие (например, "Республика Саха - Якутия" будет просто Якутией), ставит существительные в нужный падеж и т.п. для того, чтобы получился связный текст.
* Переменные и переписанные таблицы вставляются в готовый шаблон и отправляются пользователю.
* По команде $$ (ставится в конце отправленного текста) бот может отправить ответ в текстовом файле, по команде $$[число] - ограничить число регионов в переписанной таблице новых случаев, по команде "йй" (также ставится в конце отправленного текста) бот отправит подробный лог своих действий.
* Кроме того, бот выдаст сообщение-предупреждение, если одну или несколько переменных в тексте найти не удалось или если переменные меньше референсных значений, указанных в настройках.
* Также бот может парсить короткое сообщение пресс-службы Роспотребнадзора о темпах вакцинации по той же схеме.

### Технологии и библиотеки

* Python 3.9.7
* [pyTelegramBotAPI 4.2.0](https://github.com/eternnoir/pyTelegramBotAPI)
* Flask/gunicorn (для обеспечения работы через вебхук)
* pytest (автоматические тесты), venv (virtual environment), Git (контроль версий)
* yaml для парсинга yml-файла с настройками

* Основной функционал работает на регулярных выражениях (*re* из стандартной библиотеки)

* Бот сейчас запущен на *Heroku*.

### Описание функционала

#### Парсер

Ключевой функционал обеспечивается модулем *ifaxbotcovid.parser.texparser*.

- textparser ищет заданные переменные в тексте релиза в соответствии с регулярными выражениями, которые заданы в папке [/ifaxbotcovid/parser/regexp/](https://github.com/dexpiper/ifaxbotcovid/blob/main/ifaxbotcovid/parser/regexp/regex.py). Регулярные выражения подобраны с учетом возможных изменений в исходном тексте пресс-релиза, в некоторых случаях парсер перебирает несколько выражений для одной переменной.

**Переменные:**:
   - количество новых случаев COVID (24 ч.)
   - количество смертей от COVID (24 ч.)
   - выписанные пациенты (24 ч.)
   - общее число случаев COVID с начала пандемии
   - общее число смертельных исходов, связанных с COVID, с начала пандемии
   - общее число выписанных пациентов с начала пандемии
   - темп роста новых случаев ("pace")
   - "золотая цитата" - короткая подтверждающая цитата из пресс-релиза

**Сгенерированные переменные**:
   - Число активных случаев = общее число случаев - (общее число смертей + общее число выздоровевших)
   - Дейтлайн и название дня недели в нужном падеже с предлогом ("во вторник", но "в среду"). Берется из time.time() и, соответственно, зависит от времени получения сообщения на сервере и никак не зависит от даты и времени самого пресс-релиза.
   - Переписанные таблицы со статистикой в регионах.

Все переменные вставляются в шаблон. Предусмотрена возможность предобработать значения перед вставкой (напр., "1124578" => "1 млн 124 тыс. 578", "1,12 млн"). Кроме того, бот сравнивает общее число новых случаев, смертей и выписанных с референсными значениями, заданными в файле настроек. Если найденные данные будут меньше, пользователь получит предупреждение. 
Также предупреждение будет выдано, если бот не обнаружил одну или несколько переменных в тексте релиза. Вместо переменной будет проставлено значение по умолчанию (NO_VALUE).

**Дополнительная функция - сообщение Роспотребнадзора**

Бот также парсит дежурное короткое сообщение Роспотребнадзора о ситуации с тестированием на новую коронавирусную инфекцию.

Если такое сообщение поступает, бот автоматически вызывает скрипт *ifaxbotcovid.parser.rpn*, который работает со своими регулярными выражениями и вставляет данные в свой шаблон.

Ищет три переменные:
  + общее число выполненных тестов 
  + число тестов, выполненных за последние 24 часа 
  + число людей, находящихся на настоящий момент под наблюдением медиков

#### Промежуточная логика CovidChef

Бот работает как мини веб-приложение, написанное на Flask. Телеграм отправляет новые сообщения по адресу URL+TOKEN (вебхук), далее Flask передает их на обработку библиотеке pyTelegramBotAPI (Telebot), которая, в свою очередь, вызывает нужные модули и отправляет заполненный шаблон пользователю назад напрямую через Telegram API.

Telegram <==> Flask <=> Telebot <=> Парсер

Вместе с тем, идея бота изначально была в том, чтобы он работал легко и просто: пользователю нужно просто отправить релиз - и в идеале без предварительных настроек, специальных команд и т.п. он должен получить ответ. Вместе с тем, этот подход "просто отправь - просто получи" потребовал также включения промежуточного звена.

Его задачи:
- склеивать куски пресс-релиза (поскольку телеграм автоматически разрезает длинные сообщения от пользователя боту на куски не более 4090 символов и отправляет их один за одним)
- определить, что получено на входе: короткое сообщение Роспотребнадзора, длинный пресс-релиз или не относящееся к делу сообщение, которое нужно проигнорировать

Бот работает с осени 2020 года. С тех пор сообщения оперативного штаба стали более длинными, и "сырой" пресс-релиз стал разрезаться телеграмом не на две, а на три части. Это потребовало выделения промежуточного звена в отдельный элемент - CovidChef (с отдельным покрытием тестами).

Telegram <======> Flask <=> Telebot <=> *CovidChef* <=> Парсер

CovidChef инициализируется вместо с Flask и Telebot. В общих чертах он работает следующим образом:

1) Telebot передает КовидШефу каждое полученное сообщение
2) Шеф обрабатывает его и, если необходимо, дает ответ
3) Telebot отправляет этот ответ назад пользователю.

Под капотом CovidChef сохраняет сообщение с метаданными в специальном хранилище - MessageStorage (на базе deque из стандартной библиотеки, фиксированного объема). Последовательно отправленные одним пользователем сообщения с коротким интервалом между ними склеиваются, и если набор заданных ключевых слов совпадает (задаются в настройках), КовидШеф вызывает нужный парсер (главный парсер или парсер сообщения Роспотребнадзора), получает ответ, проверяет его параметры и передает Telebot'у для дальнейшей отправки пользователю.

**Переменные среды**

В системе должны быть заданы две переменные среды для корректной работы:
- *TOKEN* (полученный от BotFather)
- *URL* куда телеграм будет отправлять сообщения боту

Вебхук регистрируется вручную запросом на "*URL*/setwebhook" request.

Бота можно запустить в режиме long polling командой *python3 manage.py runtestmode*. Для корректной работы этой функции должен быть задан токен в модуле *ifaxbotcovid.config.token.TOKEN* (по умолчанию файл игнорируется .gitignore)

**Шаблоны**

Шаблоны хранятся в папке */ifaxbotcovid/config/templates/*. Вместо шаблонов по умолчанию можно задать любые другие. Плейсхолдеры для переменных передаются в фигурных скобках:

```
Какой-то текст: {name_of_variable1}, {name_of_variable2}.
Другой кусок текста
И так далее
```

Список переменных с именами и детальное их описание - в файле readme, который лежит в папке с шаблонами.

### Примеры использования

"Сырой" пресс-релиз:

```Оперативная сводка на 30.10.2020
За последние сутки в России подтвержденных случаев новой коронавирусной инфекции COVID-19 – 18283 в 84 регионах, в том числе выявлено активно 4072 (22,3%) без клинических проявлений. 

Распределение по субъектам
1	Москва	5268
2	Санкт-Петербург	801
3	Московская область	524
 <...>
 В Российской Федерации нарастающим итогом зарегистрировано 1 599 976 случая (+1,2%) коронавирусной инфекции в 85 регионах.

За последние сутки подтверждено  355 летальных случаев:
Воронежская область	1
Ивановская область	3
Калужская область	3
Костромская область	1
Курская область	4
Липецкая область	1
Московская область	13
<...>
Амурская область	2
Хабаровский край	2
За весь период по России умерло  27 656 человек.

За прошедшие сутки выписано по выздоровлению  14 519 человек: 
Белгородская область	128
Брянская область	56
Владимирская область	78
<...>
Хабаровский край	68
Сахалинская область	110
Чукотский автономный округ	1
За весь период выписано по выздоровлению по России  –  1 200 560
```

Ответ, который отправит бот (в соответствии с шаблонами по умолчанию):

```ЭМБАРГО

МОЛНИЯ
18283 НОВЫХ СЛУЧАЕВ COVID-19 В РФ (+1,2%), 355 УМЕРШИХ, 14,52 ТЫС. ВЫПИСАННЫХ – ОПЕРШТАБ

МОЛНИЯ
В МОСКВЕ 5268 НОВЫХ СЛУЧАЕВ КОРОНАВИРУСА, 69 СМЕРТЕЙ, 3985 ВЫПИСАННЫХ – ОПЕРШТАБ
ЭМБАРГО

ЭМБАРГО

ЭКСПРЕСС-РОССИЯ-COVID-СТАТИСТИКА
18,28 тыс. новых случаев COVID-19 в РФ, 355 умерших - оперштаб
Москва. 30 октября. ИНТЕРФАКС - Суточный прирост новых заболевших коронавирусной инфекцией составил 18,28 тыс. случаев, умерли за сутки 355 пациентов, следует из данных оперативного штаба, обнародованных в пятницу.
"За последние сутки в России подтвержденных случаев новой коронавирусной инфекции COVID-19 – 18283 в 84 регионах, в том числе выявлено активно 4072 (22,3%) без клинических проявлений", - говорится в сообщении штаба.
Нарастающим итогом в России зарегистрировано 1599976 случаев коронавирусной инфекции, 27656 умерших и 1200560 выписанных (14519 выписаны за последние сутки). Таким образом, общее количество активных случаев в стране (общее число случаев за вычетом всех выздоровевших и всех умерших) на текущий момент составляет 371760.

ПОКАЗАТЕЛИ ПРИРОСТА И СМЕРТНОСТИ В СТОЛИЦЕ И РЕГИОНАХ
В Москве в пятницу, сообщает оперативный штаб, 5268 новых случаев COVID-19 за сутки, 69 смертей и 3985 выздоровевших.
По информации оперативного штаба, еще 801 новых случаев COVID-19 зафиксировано в Санкт-Петербурге, 524 - в Московской области, 401 - в Нижегородской области, 325 - в Архангельской области, 310 - в Ростовской области, 296 - в Воронежской области, 292 - в Красноярском крае, 284 - в Свердловской области, по 232 - в Иркутской области, Забайкальском крае. 231 - в Коми, 224 - в Хабаровском крае, 219 - в Алтайском крае, 216 - в Крыму, 215 - в Бурятии, <...> 151 - в Челябинской области, В других регионах России суточный прирост не превышает 150.

Согласно данным оперштаба о смертности, 69 пациентов скончалось за сутки в Москве, 36 - в Санкт-Петербурге, 15 - в Ростовской области, по 13 летальных случаев в Московской области, Нижегородской области. По 8 умерших в Республике Алтай, Бурятии, Якутии, Иркутской области, Красноярском крае. <...> По 2 - в Крыму, Кабардино-Балкарии, Амурской области, Орловской области, Тульской области, Пензенской области, Челябинской области, Хабаровском крае, Севастополе. По 1 - в Башкирии, Марий Эл, Мордовии, Татарстане, Калининградской области, Кировской области, Воронежской области, Костромской области, Липецкой области, Рязанской области. 
1** ЭМБАРГО
```

### Структура проекта

```
/
wsgi.py                    - *Flask routes, Chef instance creation*
manual_parse.py            - *ручной вызов textparser.py*
manual_rpn_parse.py        - *ручной вызов rpn.py*

  /ifaxbotcovid
    
    /bot
        logic.py               - *CovidChef*
        helpers.py             - *вспомогательные функции CovidChef*
        factory.py             - *Flask, Telebot и Chef*
        handlers.py            - *Telebot handlers для обработки сообщений*
        ...

    /parser

        textparser.py          - *главный модуль для парсинга большого пресс-релиза*
        rpn.py                 - *парсер короткого сообщения Роспотребнадзора*
        ...

        /lib
        /regexp
            
            regex.py               - *регулярные выражения для главного парсера*
            ...

    /config
        /templates
            flashtemplate.txt
            rpntemplate.txt
            texttemplate.txt
        /utils
            tmploader.py            - *загрузчик шаблонов из файлов*
            settings.py             - *парсер настроек из yml-файла*
            ...

        logging.ini            - *настройки логирования*
        settings.yml           - *ключевые слова, референсные значения переменных, версия приложения и т.п.*
        messagestart.txt       - *сообщение в ответ на команду /start*
        messagehelp.txt        - *сообщение в ответ на команду /help*
            

  /tests
    ...
    /unit_tests

        /bot
        /parser
    
    /test_data

        sample_xxx.txt     - *вводные для тестов, файлы с разрешением.txt. Любой файл вида "sample_xxx.txt" в папке используется для прогона тестов*

        corrupted_xxx.txt  - *файлы со словом "corrupted" в имени специально помещены в папку для того, чтобы проверить, как тесты "ловят" те или иные ошибки в заданных данных*
        ...
```

### Источники

Проект был вдохновлен красотой и простотой Python, а также:

* [гайдом](https://tproger.ru/translations/telegram-bot-create-and-deploy/) на сайте tproger 
* [Книгой "Automate the boring staff with Python"](https://automatetheboringstuff.com/) автора Al Sweigart
* [Книгой "Fluent Python"](https://www.oreilly.com/library/view/fluent-python/9781491946237/) автора Luciano Ramalho
* Моими отзывчивыми коллегами

Летом 2020 года проект был написан как набор плохо написанных скриптов на локальной машине, и со временем эволюционировал в телеграм-бота, который экономит время и силы репортерам. Вместе с проектом эволюционировал и автор, отсюда многие особенности архитектуры, которые еще сохраняют очертания спорадически, на скорую руку написанных скриптов.

### Дальнейшая разработка

В дальнейшем планирую прикрутить к боту базу данных, чтобы дать пользователю возможность задавать свои шаблоны. Это позволит использовать бота широкому кругу пользователей, а не только журналистам Интерфакса.